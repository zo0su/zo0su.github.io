-- CodeJudge 데이터베이스 테이블 구조

-- 문제 테이블
CREATE TABLE IF NOT EXISTS problems (
    id SERIAL PRIMARY KEY,
    assignment VARCHAR(100) DEFAULT '과제 1',
    title VARCHAR(255) NOT NULL,
    description TEXT,
    constraints TEXT,
    input_format TEXT,
    output_format TEXT,
    difficulty VARCHAR(50),
    deadline TIMESTAMP,
    allow_late_submission BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 학생 테이블
CREATE TABLE IF NOT EXISTS students (
    id SERIAL PRIMARY KEY,
    student_id VARCHAR(7) UNIQUE NOT NULL CHECK (LENGTH(student_id) = 7 AND student_id ~ '^[0-9]+$'),
    password VARCHAR(255) NOT NULL,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(255) NOT NULL,
    approved BOOLEAN DEFAULT false,
    password_changed BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 제출 기록 테이블
CREATE TABLE IF NOT EXISTS submissions (
    id SERIAL PRIMARY KEY,
    problem_id INTEGER REFERENCES problems(id) ON DELETE CASCADE,
    student_id VARCHAR(50) NOT NULL,
    student_name VARCHAR(100) NOT NULL,
    student_email VARCHAR(255) NOT NULL,
    code TEXT NOT NULL,
    status VARCHAR(50) DEFAULT 'pending',
    score INTEGER DEFAULT 0,
    review_note TEXT,
    typing_data JSONB,
    memory_usage INTEGER,
    execution_time INTEGER,
    created_at TIMESTAMP DEFAULT NOW(),
    reviewed_at TIMESTAMP
);

-- 인덱스 생성
CREATE INDEX IF NOT EXISTS idx_submissions_problem_id ON submissions(problem_id);
CREATE INDEX IF NOT EXISTS idx_submissions_student_id ON submissions(student_id);
CREATE INDEX IF NOT EXISTS idx_submissions_status ON submissions(status);
CREATE INDEX IF NOT EXISTS idx_submissions_created_at ON submissions(created_at);

-- 샘플 문제 데이터는 제거되었습니다.
-- 관리자가 문제 관리 탭에서 직접 문제를 등록하세요.

